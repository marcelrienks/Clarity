# Wokwi Integration Testing Strategy

## Overview

This document outlines the comprehensive testing strategy for the Clarity automotive gauge system using Wokwi simulation, based on official Wokwi recommendations and best practices as of 2024.

## Research Foundation

### Wokwi's Official Recommendations (2024)

Based on extensive research of Wokwi's documentation and best practices:

**WITL Methodology**: Wokwi recommends "Wokwi in the Loop" testing methodology which combines:
- Speed of unit testing
- Realism of hardware testing
- Automated firmware verification via serial output monitoring

**Current State of Automation** (2024):
- ✅ **Wokwi CLI**: Stable and production-ready for basic testing
- ⚠️ **Automation Scenarios**: In ALPHA stage, API may change
- ❌ **DIP Switch Automation**: Not yet supported in automation scenarios
- ✅ **Serial Monitoring**: Primary method for automated verification

**Supported Automated Controls**:
- Push Buttons: `pressed` state control
- Potentiometers: `position` value control  
- MPU6050 Sensor: acceleration, rotation, temperature
- Delays: Time-based test pacing
- Serial Monitoring: Pattern matching for verification

## Testing Architecture

### 3-Tier Testing Strategy

Our approach implements a comprehensive 3-tier testing strategy that aligns with Wokwi's current capabilities:

```
Tier 1: Automated Startup Test    → Quick validation (30s)
Tier 2: Guided Integration Test   → Comprehensive WITL (5-10 min)
Tier 3: Manual Debug Test         → Development debugging (unlimited)
```

#### Tier 1: Automated Startup Test

**File**: `test/wokwi/wokwi_startup_test.sh`
**Purpose**: Automated smoke testing for CI/CD
**Duration**: 30 seconds
**Automation Level**: 100% automated

**What it Tests**:
- System initialization sequence
- Service startup and configuration
- SplashPanel loading and transition
- OemOilPanel loading and basic functionality
- Custom `log_t()` function verification

**Success Criteria**:
```bash
✅ [T] SplashPanel loaded successfully
✅ [T] OemOilPanel loaded successfully
✅ System enters normal operation loop
```

**Usage**:
```bash
cd test/wokwi
./wokwi_startup_test.sh
```

#### Tier 2: Guided Integration Test (WITL)

**File**: `test/wokwi/wokwi_guided_test.sh`
**Purpose**: Comprehensive integration testing following WITL methodology
**Duration**: 5-10 minutes
**Automation Level**: Semi-automated (manual actions, automated verification)

**WITL Implementation**:
- **Manual Component**: User performs hardware interactions via Wokwi web interface
- **Automated Component**: Script monitors serial output and verifies expected patterns
- **Verification**: Automatic detection of `log_t()` messages and system responses

**Test Phases**:

1. **System Startup** (Automated)
   - Monitors automatic startup sequence
   - Verifies panel loading messages

2. **Theme and Trigger System** (Guided)
   - User: Activate DIP switches for triggers
   - Script: Verifies `[T] LightsOnActivate`, `[T] LockEngagedActivate`, `[T] KeyNotPresentActivate`

3. **Button Actions** (Guided)
   - User: Perform short/long button presses
   - Script: Verifies `[T] ShortPressActivate`, `[T] LongPressActivate`

4. **Error System** (Guided)
   - User: Trigger debug error button
   - Script: Verifies `[T] ErrorOccurredActivate`

5. **System Restoration** (Guided)
   - User: Deactivate all triggers
   - Script: Verifies `[T] No blocking interrupts - restoring`

**Technical Implementation**:
- Uses named pipes for real-time serial monitoring
- Pattern matching with timeouts for each verification step
- Comprehensive error handling and user feedback
- Professional colored output with clear pass/fail indicators

**Usage**:
```bash
cd test/wokwi
./wokwi_guided_test.sh
```

#### Tier 3: Manual Debug Test

**File**: `test/manual/wokwi_debug.sh`
**Purpose**: Interactive development and debugging
**Duration**: Unlimited (manual control)
**Automation Level**: Manual with full verbose logging

**Features**:
- Full verbose logging (CORE_DEBUG_LEVEL=5)
- All log levels: `[V]`, `[D]`, `[I]`, `[W]`, `[E]`, `[T]`
- No timeout - complete manual control
- Hardware mapping documentation
- Perfect for development and troubleshooting

**Usage**:
```bash
cd test/manual
./wokwi_debug.sh
```

## Technical Implementation Details

### Build Environments

**Integration Testing Environment** (`test-wokwi`):
```ini
[env:test-wokwi]
build_flags = 
    -D CORE_DEBUG_LEVEL=3  # INFO level only
    -D CLARITY_DEBUG
    -D WOKWI_EMULATOR
```

**Manual Debug Environment** (`debug-local`):
```ini
[env:debug-local]  
build_flags = 
    -D CORE_DEBUG_LEVEL=5  # VERBOSE level
    -D CLARITY_DEBUG
    -D WOKWI_EMULATOR
```

### Serial Pattern Verification

The testing strategy relies on monitoring specific serial patterns generated by the custom `log_t()` function:

**Key Patterns Monitored**:
```bash
[T] SplashPanel loaded successfully
[T] OemOilPanel loaded successfully
[T] KeyPresentActivate() - Loading KEY panel
[T] LightsOnActivate() - Setting NIGHT theme
[T] ShortPressActivate() - Executing short press action
[T] LongPressActivate() - Executing long press action
[T] ErrorOccurredActivate() - Loading ERROR panel
[T] No blocking interrupts - restoring to 'OemOilPanel'
```

### Hardware Simulation Mapping

```yaml
Hardware Controls:
  action_button: "btn1"    # GPIO 32 - Main user input
  debug_button: "btn2"     # GPIO 34 - Debug error trigger
  pressure_pot: "pot1"     # GPIO 36 - Oil pressure simulation
  temp_pot: "pot2"         # GPIO 39 - Oil temperature simulation
  dip_switch: "sw1"        # 4-position trigger control
    position_1: GPIO 25    # Key Present trigger
    position_2: GPIO 26    # Key Not Present trigger
    position_3: GPIO 27    # Lock trigger
    position_4: GPIO 33    # Lights trigger
```

## Integration with Development Workflow

### Development Workflow

1. **Feature Development**:
   ```bash
   pio run -e debug-local
   cd test/manual && ./wokwi_debug.sh
   # Full verbose debugging with manual interaction
   ```

2. **Feature Testing**:
   ```bash
   pio run -e test-wokwi  
   cd test/wokwi && ./wokwi_guided_test.sh
   # Comprehensive integration testing with WITL methodology
   ```

3. **CI/CD Validation**:
   ```bash
   pio run -e test-wokwi
   cd test/wokwi && ./wokwi_startup_test.sh
   # Quick automated smoke testing
   ```

### CI/CD Integration

**GitHub Actions Example**:
```yaml
name: Wokwi Integration Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install PlatformIO
        run: pip install platformio
      - name: Install Wokwi CLI
        run: |
          curl -L https://github.com/wokwi/wokwi-cli/releases/latest/download/wokwi-cli-linux -o /usr/local/bin/wokwi-cli
          chmod +x /usr/local/bin/wokwi-cli
      - name: Run Startup Test
        run: |
          cd test/wokwi
          ./wokwi_startup_test.sh
```

## Benefits and Rationale

### Why This Approach Works

**Addresses Wokwi Limitations**:
- DIP switches not automatable → Guided manual interaction
- Complex scenarios unsupported → Step-by-step WITL methodology
- Alpha automation features → Stable CLI-based approach

**Follows Official Best Practices**:
- ✅ Uses Wokwi CLI (stable, recommended)
- ✅ Implements WITL methodology exactly
- ✅ Serial monitoring for verification
- ✅ Realistic hardware interaction simulation

**Practical for Development**:
- Quick automated smoke testing for CI/CD
- Comprehensive guided testing for validation
- Full manual debugging for development
- Clear documentation and professional output

### Performance Characteristics

**Automated Startup Test** (Tier 1):
- **Duration**: 30 seconds
- **Coverage**: System initialization, basic panel loading
- **Automation**: 100%
- **Use Case**: CI/CD, quick validation

**Guided Integration Test** (Tier 2):
- **Duration**: 5-10 minutes
- **Coverage**: Complete system functionality
- **Automation**: 50% (automated verification, manual actions)
- **Use Case**: Pre-release validation, comprehensive testing

**Manual Debug Test** (Tier 3):
- **Duration**: Unlimited
- **Coverage**: Complete system with full debug info
- **Automation**: 0% (full manual control)
- **Use Case**: Development, debugging, investigation

## Future Considerations

### When Wokwi Automation Scenarios Mature

When Wokwi's automation scenarios exit ALPHA and support DIP switches:

1. **Upgrade Tier 2 to Full Automation**:
   - Convert `wokwi_guided_test.sh` to use automation scenarios
   - Maintain WITL verification methodology
   - Keep guided version as fallback

2. **Potential YAML Automation**:
   ```yaml
   name: 'Clarity Full Integration Test'
   version: 1
   steps:
     - wait-serial: '[T] OemOilPanel loaded successfully'
     - set-control:
         part-id: sw1
         control: position_4
         value: 1
     - wait-serial: '[T] LightsOnActivate'
   ```

3. **Maintain 3-Tier Structure**:
   - Keep all three tiers for different use cases
   - Enhance automation where possible
   - Preserve manual debugging capabilities

## Conclusion

This 3-tier testing strategy provides:

- **Comprehensive Coverage**: From quick smoke tests to full integration validation
- **Wokwi Best Practice Compliance**: Follows official WITL methodology
- **Practical Implementation**: Works within current Wokwi limitations  
- **Professional Quality**: Clear documentation, error handling, user feedback
- **Future-Proof**: Ready to adopt enhanced automation when available

The strategy successfully addresses the original problem of integration tests getting stuck in idle loops by providing structured, guided interaction combined with automated verification - exactly what Wokwi recommends for complex embedded systems testing in 2024.